<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jit Jot Radio</title>
  <style>
    body {
      margin: 0;
      background-color: #000;
      color: #fff;
      font-family: monospace;
      text-align: center;
      padding: 2em 1em;
    }
    h1 {
      font-size: 2em;
      margin-bottom: 0.5em;
    }
    #info {
      margin: 1em 0;
      font-size: 1.2em;
    }
    #volumeControl {
      margin-top: 1em;
    }
    #volume {
      width: 300px;
    }
    iframe {
      display: none;
    }
  </style>
</head>
<body>
  <h1>ðŸ“» Jit Jot Radio</h1>
  <div id="info">Cargando radio...</div>
  <div id="volumeControl">
    <label for="volume">ðŸ”Š Volumen</label><br />
    <input type="range" id="volume" min="0" max="1" step="0.01" value="0.8" />
  </div>
  <div id="player"></div>

  <script>
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS0uilsv3McF9pbIwdO_awWhgL3Kg7n09nbw5YlCM4oIaPXO6MhnS0p6KYrDxdEM_LnvktccPHctDmK/pub?gid=0&single=true&output=csv';

    let tracks = [];
    let currentTag = "";
    let currentTrack = null;

    function getCurrentTag(tags) {
      const utcHour = new Date().getUTCHours();
      return tags[utcHour % tags.length];
    }

    function loadCSV(url) {
      return fetch(url)
        .then(res => res.text())
        .then(text => {
          const lines = text.trim().split('\n');
          const rows = lines.slice(1); // skip header
          return rows.map(row => {
            const [videoId, title, tags, dur] = row.split(',');
            return {
              videoId: videoId.trim(),
              title: title.trim(),
              tags: tags.toLowerCase().split(/[,;]/).map(t => t.trim()),
              duration: parseInt(dur.trim())
            };
          });
        });
    }

    function getTrackForCurrentTime(tag, trackList) {
      const now = new Date();
      const startOfHour = new Date(now);
      startOfHour.setUTCMinutes(0, 0, 0);
      const secondsIntoBlock = Math.floor((now - startOfHour) / 1000);

      const tagTracks = trackList.filter(t => t.tags.includes(tag));
      if (tagTracks.length === 0) return null;

      let total = 0;
      for (const track of tagTracks) {
        if (total + track.duration > secondsIntoBlock) {
          return { ...track, start: secondsIntoBlock - total };
        }
        total += track.duration;
      }
      // si se termina el bloque, empezar desde el primer track
      return { ...tagTracks[0], start: 0 };
    }

    function playTrack(track) {
      const iframe = document.createElement('iframe');
      iframe.src = `https://www.youtube.com/embed/${track.videoId}?autoplay=1&start=${track.start}&controls=0&rel=0&modestbranding=1&playsinline=1`;
      iframe.allow = 'autoplay';
      iframe.id = 'ytplayer';
      document.getElementById('player').innerHTML = '';
      document.getElementById('player').appendChild(iframe);

      document.getElementById('info').innerText = `ðŸŽ¶ ${track.title} [${currentTag}]`;
    }

    function setVolume(value) {
      const iframe = document.getElementById('ytplayer');
      if (!iframe) return;
      const message = {
        event: 'command',
        func: 'setVolume',
        args: [value * 100]
      };
      iframe.contentWindow.postMessage(JSON.stringify(message), '*');
    }

    document.getElementById('volume').addEventListener('input', (e) => {
      setVolume(parseFloat(e.target.value));
    });

    loadCSV(SHEET_URL).then(allTracks => {
      tracks = allTracks;
      const uniqueTags = [...new Set(tracks.flatMap(t => t.tags))];
      currentTag = getCurrentTag(uniqueTags);
      currentTrack = getTrackForCurrentTime(currentTag, tracks);
      if (currentTrack) {
        playTrack(currentTrack);
      } else {
        document.getElementById('info').innerText = 'No hay mÃºsica disponible para esta hora ðŸ˜¢';
      }
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jit Jot Radio</title>
<style>
  body {
    background: #111;
    color: #eee;
    font-family: monospace, monospace;
    text-align: center;
    margin: 0; padding: 20px;
  }
  #player {
    margin: 20px auto;
    max-width: 560px;
    aspect-ratio: 16 / 9;
  }
  #now-playing {
    margin-top: 10px;
    font-size: 1.1rem;
  }
  #tags {
    margin: 10px 0 20px;
    font-style: italic;
    color: #888;
  }
  #history {
    max-width: 560px;
    margin: 0 auto;
    text-align: left;
    background: #222;
    padding: 10px;
    border-radius: 6px;
    font-size: 0.9rem;
  }
  #history h3 {
    margin-top: 0;
  }
  #history ul {
    margin: 0; padding-left: 20px;
  }
</style>
</head>
<body>

<h1>ðŸŽ§ Jit Jot Radio</h1>

<div id="player"></div>

<div id="now-playing"></div>
<div id="tags"></div>

<div id="history">
  <h3>Historial</h3>
  <ul id="history-list"></ul>
</div>

<script>
// URL de tu CSV pÃºblico
const sheetCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS0uilsv3McF9pbIwdO_awWhgL3Kg7n09nbw5YlCM4oIaPXO6MhnS0p6KYrDxdEM_LnvktccPHctDmK/pub?gid=0&single=true&output=csv';

// Variables globales
let playlist = [];
let currentIndex = 0;
const historyMax = 10;
const historyList = [];

const playerDiv = document.getElementById('player');
const nowPlayingDiv = document.getElementById('now-playing');
const tagsDiv = document.getElementById('tags');
const historyUl = document.getElementById('history-list');

let player;

// Crea reproductor YouTube usando API
function createPlayer(videoId) {
  if (player) {
    player.loadVideoById(videoId);
  } else {
    player = new YT.Player('player', {
      height: '315',
      width: '560',
      videoId: videoId,
      playerVars: {
        autoplay: 1,
        controls: 1,
        rel: 0,
      },
      events: {
        'onStateChange': onPlayerStateChange
      }
    });
  }
}

function updateNowPlaying(title, tags) {
  nowPlayingDiv.textContent = `Reproduciendo: ${title}`;
  tagsDiv.textContent = `Tags: ${tags}`;
}

function updateHistory(title) {
  historyList.unshift(title);
  if (historyList.length > historyMax) {
    historyList.pop();
  }
  historyUl.innerHTML = '';
  historyList.forEach(t => {
    const li = document.createElement('li');
    li.textContent = t;
    historyUl.appendChild(li);
  });
}

function nextTrack() {
  if (playlist.length === 0) return;
  const item = playlist[currentIndex];
  createPlayer(item.videoId);
  updateNowPlaying(item.title, item.tags);
  updateHistory(item.title);
  currentIndex++;
  if (currentIndex >= playlist.length) currentIndex = 0;
}

// Detecta cuando el video termina para avanzar
function onPlayerStateChange(event) {
  if (event.data == YT.PlayerState.ENDED) {
    nextTrack();
  }
}

// Parsear CSV sencillo
function parseCSV(text) {
  const lines = text.trim().split('\n');
  const result = [];
  for (let i=1; i<lines.length; i++) {
    const [videoId, title, tags] = lines[i].split(',');
    result.push({videoId, title, tags});
  }
  return result;
}

// Cargar API YouTube y despuÃ©s cargar playlist
function loadYouTubeAPI() {
  const tag = document.createElement('script');
  tag.src = "https://www.youtube.com/iframe_api";
  document.body.appendChild(tag);
}

function onYouTubeIframeAPIReady() {
  fetch(sheetCsvUrl)
    .then(response => response.text())
    .then(data => {
      playlist = parseCSV(data);
      nextTrack();
    })
    .catch(err => {
      nowPlayingDiv.textContent = 'Error cargando la lista de reproducciÃ³n.';
      console.error(err);
    });
}

window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;
loadYouTubeAPI();
</script>

</body>
</html>

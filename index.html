<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jit Jot Radio - Radio en Vivo</title>
<style>
  body {
    background: #111;
    color: #eee;
    font-family: monospace, monospace;
    text-align: center;
    margin: 0; padding: 20px;
  }
  #player {
    margin: 20px auto;
    max-width: 560px;
    aspect-ratio: 16 / 9;
  }
  #now-playing {
    margin-top: 10px;
    font-size: 1.1rem;
  }
  #tags {
    margin: 10px 0 20px;
    font-style: italic;
    color: #888;
  }
  #history {
    max-width: 560px;
    margin: 20px auto 0;
    text-align: left;
    background: #222;
    padding: 10px;
    border-radius: 6px;
    font-size: 0.9rem;
    overflow-y: auto;
    max-height: 250px;
  }
  #history h3 {
    margin-top: 0;
  }
  #history .block {
    margin-bottom: 10px;
    border-bottom: 1px solid #444;
    padding-bottom: 8px;
  }
  #history ul {
    margin: 5px 0 0;
    padding-left: 20px;
  }
  #history li {
    margin-bottom: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  #history li:hover {
    background: #333;
  }
  #history img.thumb {
    width: 60px;
    height: 40px;
    object-fit: cover;
    border-radius: 3px;
  }
  #history span.title {
    flex-grow: 1;
  }
</style>
</head>
<body>

<h1>üéß Jit Jot Radio - Radio en Vivo</h1>

<div id="player"></div>

<div id="now-playing"></div>
<div id="tags"></div>

<div id="history">
  <h3>Historial</h3>
  <div id="history-blocks"></div>
</div>

<script>
const sheetCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS0uilsv3McF9pbIwdO_awWhgL3Kg7n09nbw5YlCM4oIaPXO6MhnS0p6KYrDxdEM_LnvktccPHctDmK/pub?gid=0&single=true&output=csv';

let playlist = [];
let player;
let historyList = [];
const maxHistory = 20; // cu√°ntos videos recordar en historial

const playerDiv = document.getElementById('player');
const nowPlayingDiv = document.getElementById('now-playing');
const tagsDiv = document.getElementById('tags');
const historyBlocksDiv = document.getElementById('history-blocks');

let userTriggered = false; // para saber si usuario hizo click en historial y queremos pausar el autoplay del radio en vivo

// Parse CSV con 4 columnas: videoId,title,tags,durationSeconds
function parseCSV(text) {
  const lines = text.trim().split('\n');
  const result = [];
  for (let i=1; i<lines.length; i++) {
    const parts = lines[i].split(',');
    if(parts.length < 4) continue;
    const [videoId, title, tags, duration] = parts;
    result.push({
      videoId: videoId.trim(),
      title: title.trim(),
      tags: tags.trim(),
      duration: parseInt(duration.trim()) || 240
    });
  }
  return result;
}

// Crea player o carga video
function createPlayer(videoId, startSeconds=0) {
  if(player) {
    player.loadVideoById({videoId: videoId, startSeconds: startSeconds});
  } else {
    player = new YT.Player('player', {
      height: '315',
      width: '560',
      videoId: videoId,
      playerVars: {
        autoplay: 1,
        controls: 1,
        rel: 0,
        start: startSeconds
      },
      events: {
        'onStateChange': onPlayerStateChange
      }
    });
  }
}

// Actualiza textos en pantalla
function updateNowPlaying(title, tags) {
  nowPlayingDiv.textContent = `Reproduciendo: ${title}`;
  tagsDiv.textContent = `Tags: ${tags}`;
}

// A√±ade video al historial y actualiza DOM
function addToHistory(video) {
  // No duplicados en historial reciente
  if(historyList.length > 0 && historyList[0].videoId === video.videoId) return;
  historyList.unshift(video);
  if(historyList.length > maxHistory) historyList.pop();
  renderHistory();
}

// Renderiza historial con miniaturas y click para reproducir
function renderHistory() {
  // Para bloques, aqu√≠ solo un bloque, pod√©s extender la l√≥gica para dividir en bloques por d√≠a, hora, etc.
  historyBlocksDiv.innerHTML = '';
  const block = document.createElement('div');
  block.className = 'block';

  const ul = document.createElement('ul');
  historyList.forEach((item, idx) => {
    const li = document.createElement('li');
    li.title = `Escuchar "${item.title}" de nuevo`;
    li.onclick = () => {
      userTriggered = true;
      playVideoByIndex(playlist.findIndex(v => v.videoId === item.videoId));
    };

    const img = document.createElement('img');
    img.className = 'thumb';
    img.src = `https://img.youtube.com/vi/${item.videoId}/default.jpg`;
    img.alt = item.title;

    const span = document.createElement('span');
    span.className = 'title';
    span.textContent = item.title;

    li.appendChild(img);
    li.appendChild(span);
    ul.appendChild(li);
  });

  block.appendChild(ul);
  historyBlocksDiv.appendChild(block);
}

// Calcula qu√© video y en qu√© segundo debe sonar seg√∫n tiempo UTC y duraci√≥n del playlist
function calculateCurrentVideoAndTime() {
  const totalDuration = playlist.reduce((sum, v) => sum + v.duration, 0);
  if(totalDuration === 0) return {index:0, time:0};

  // Segundos desde epoch modulo total duraci√≥n para loop infinito
  const nowSeconds = Math.floor(Date.now() / 1000);
  const loopSeconds = nowSeconds % totalDuration;

  // Buscar qu√© video toca
  let accumulator = 0;
  for(let i=0; i < playlist.length; i++) {
    accumulator += playlist[i].duration;
    if(loopSeconds < accumulator) {
      const startInVideo = loopSeconds - (accumulator - playlist[i].duration);
      return {index: i, time: startInVideo};
    }
  }

  // fallback
  return {index:0, time:0};
}

// Reproduce video por √≠ndice en playlist y agrega a historial
function playVideoByIndex(i, startSeconds=0) {
  if(i < 0 || i >= playlist.length) return;
  const video = playlist[i];
  updateNowPlaying(video.title, video.tags);
  createPlayer(video.videoId, startSeconds);
  addToHistory(video);
  currentPlayingIndex = i;
  currentPlayingStartTime = startSeconds;
}

// Maneja cambios de estado del reproductor
function onPlayerStateChange(event) {
  if(event.data == YT.PlayerState.ENDED) {
    if(!userTriggered) {
      // Si no fue click manual, avanzar al siguiente video en radio en vivo
      let nextIndex = (currentPlayingIndex + 1) % playlist.length;
      playVideoByIndex(nextIndex, 0);
    }
  }
}

// Variables globales para estado actual
let currentPlayingIndex = 0;
let currentPlayingStartTime = 0;

// Cargar playlist y arrancar radio sincronizada
function startRadio() {
  fetch(sheetCsvUrl)
    .then(r => r.text())
    .then(text => {
      playlist = parseCSV(text);
      if(playlist.length === 0) {
        nowPlayingDiv.textContent = 'La lista de reproducci√≥n est√° vac√≠a.';
        return;
      }
      // Calcular video actual y posici√≥n seg√∫n tiempo real
      const {index, time} = calculateCurrentVideoAndTime();
      userTriggered = false;
      playVideoByIndex(index, time);
    })
    .catch(err => {
      nowPlayingDiv.textContent = 'Error cargando la lista de reproducci√≥n.';
      console.error(err);
    });
}

// Cargar API de YouTube y arrancar radio al estar lista
function loadYouTubeAPI() {
  const tag = document.createElement('script');
  tag.src = 'https://www.youtube.com/iframe_api';
  document.body.appendChild(tag);
}

window.onYouTubeIframeAPIReady = function() {
  startRadio();
};

loadYouTubeAPI();

</script>
</body>
</html>

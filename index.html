<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jit Jot Radio</title>
  <style>
    body {
      background: black;
      color: white;
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    h1 {
      font-size: 2em;
      margin: 1em 0;
    }
    #player {
      display: none;
    }
    #history {
      margin: 2em 0;
    }
    .thumbnail {
      width: 120px;
      margin: 5px;
      display: inline-block;
    }
    .next {
      margin-top: 2em;
    }
    .next img {
      width: 160px;
    }
    #volumeControl {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Jit Jot Radio</h1>
  <div id="nowPlaying">Cargando...</div>
  <div id="volumeControl">
    Volumen:
    <input type="range" min="0" max="100" value="50" id="volumeSlider" />
  </div>

  <div id="history">
    <h2>Historial</h2>
    <div id="historyContainer"></div>
  </div>

  <div class="next">
    <h2>Siguiente:</h2>
    <div id="nextContainer"></div>
  </div>

  <iframe
    id="player"
    type="text/html"
    width="0"
    height="0"
    src=""
    frameborder="0"
    allow="autoplay"
  ></iframe>

  <script>
    const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS0uilsv3McF9pbIwdO_awWhgL3Kg7n09nbw5YlCM4oIaPXO6MhnS0p6KYrDxdEM_LnvktccPHctDmK/pub?gid=0&single=true&output=csv";
    let playlist = [];
    let currentIndex = 0;
    let history = [];

    function loadCSV(url, callback) {
      fetch(url)
        .then((response) => response.text())
        .then((data) => {
          const lines = data.split("\n").slice(1);
          const result = lines.map((line) => {
            const [title, youtubeId, startSeconds, endSeconds] = line.split(",");
            return {
              title: title.trim(),
              id: youtubeId.trim(),
              start: parseInt(startSeconds.trim()),
              end: parseInt(endSeconds.trim()),
            };
          });
          callback(result.filter(item => item.id));
        });
    }

    function playTrack(index) {
      if (index >= playlist.length) index = 0;
      currentIndex = index;
      const track = playlist[index];

      const player = document.getElementById("player");
      const src = `https://www.youtube.com/embed/${track.id}?start=${track.start}&end=${track.end}&autoplay=1&controls=0&modestbranding=1`;
      player.src = src;

      document.getElementById("nowPlaying").innerText = `▶️ ${track.title}`;

      // Historial
      if (history.length > 0 && history[0].id !== track.id) {
        history.unshift(track);
        if (history.length > 10) history.pop();
        renderHistory();
      }

      // Siguiente
      renderNext(index + 1);

      // Programar el siguiente tema
      const duration = (track.end - track.start) * 1000;
      setTimeout(() => playTrack(index + 1), duration);
    }

    function renderHistory() {
      const container = document.getElementById("historyContainer");
      container.innerHTML = "";
      history.slice(1).forEach((track) => {
        const div = document.createElement("div");
        div.className = "thumbnail";
        div.innerHTML = `
          <a href="https://youtu.be/${track.id}" target="_blank">
            <img src="https://img.youtube.com/vi/${track.id}/default.jpg" alt="${track.title}" />
            <div style="font-size: 0.8em;">${track.title}</div>
          </a>`;
        container.appendChild(div);
      });
    }

    function renderNext(index) {
      if (index >= playlist.length) index = 0;
      const nextTrack = playlist[index];
      const container = document.getElementById("nextContainer");
      container.innerHTML = `
        <div>
          <img src="https://img.youtube.com/vi/${nextTrack.id}/default.jpg" />
          <div style="font-size: 1em;">${nextTrack.title}</div>
        </div>`;
    }

    // Volumen
    document.getElementById("volumeSlider").addEventListener("input", (e) => {
      const volume = e.target.value;
      const iframe = document.getElementById("player");
      iframe.contentWindow.postMessage(
        JSON.stringify({
          event: "command",
          func: "setVolume",
          args: [volume],
        }),
        "*"
      );
    });

    loadCSV(sheetURL, (data) => {
      playlist = data;
      playTrack(0);
    });
  </script>
</body>
</html>
